<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, max-age=0">
    <base href="/dms-gis-grosseto/">
    <link rel="preload" as="script" href="./assets/js/app-v20250912.js">
    <title>DMS • GIS Grosseto - Sistema Mercati</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Proj4 per conversioni coordinate -->
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.min.js"></script>
    
    <!-- Definizione proiezione EPSG:3003 (Gauss-Boaga Ovest) -->
    <script>
    /* Gauss–Boaga Ovest (Toscana / Grosseto) */
    proj4.defs('EPSG:3003',
      '+proj=tmerc +lat_0=0 +lon_0=9 +k=0.9996 +x_0=1500000 +y_0=0 ' +
      '+ellps=intl +towgs84=-104.1,-49.1,-9.9,0.971,-2.917,0.714,11.68 ' +
      '+units=m +no_defs +axis=neu');
    </script>
    
    <!-- Font Awesome per icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- CSS personalizzato -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header principale -->
    <header class="main-header">
        <div class="header-left">
            <img src="marker-icon.png" alt="DMS Logo" class="logo">
            <h1>DMS • GIS Grosseto</h1>
        </div>
        <div class="header-right">
            <button id="btnConfigDMS" class="btn-primary">
                <i class="fas fa-cog"></i> Configura DMS
            </button>
            <button id="btnStats" class="btn-secondary">
                <i class="fas fa-chart-bar"></i> Statistiche
            </button>
            <button onclick="exportPresenzeCSV()" class="btn-secondary">
                <i class="fas fa-download"></i> Export CSV
            </button>
        </div>
    </header>

    <!-- Layout principale con sidebar -->
    <div class="main-layout">
        <!-- Sidebar sinistra (stile g3w-suite) -->
        <div class="sidebar-left" id="sidebarLeft">
            <div class="sidebar-header">
                <h3><i class="fas fa-layer-group"></i> Strati</h3>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <!-- Controlli layer -->
            <div class="layer-controls">
                <div class="layer-group">
                    <div class="layer-group-header">
                        <i class="fas fa-folder-open"></i>
                        <span>Mercati_test_v3</span>
                    </div>
                    
                    <div class="layer-group-content">
                        <!-- Layer Mercati -->
                        <div class="layer-item">
                            <div class="layer-checkbox">
                                <input type="checkbox" id="layerMercati" checked>
                                <label for="layerMercati">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Mercati
                                </label>
                            </div>
                        </div>
                        
                        <!-- Layer Posteggi Mercati -->
                        <div class="layer-item">
                            <div class="layer-group-header">
                                <i class="fas fa-folder"></i>
                                <span>Posteggi Mercati</span>
                            </div>
                            <div class="layer-subgroup">
                                <div class="layer-checkbox">
                                    <input type="checkbox" id="layerEsperanto" checked>
                                    <label for="layerEsperanto">
                                        <i class="fas fa-square"></i>
                                        Esperanto Settimanale-Giovedì
                                    </label>
                                </div>
                                <div class="layer-checkbox">
                                    <input type="checkbox" id="layerTripoli" checked>
                                    <label for="layerTripoli">
                                        <i class="fas fa-square"></i>
                                        Tripoli Giornaliero
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabella Posteggi -->
                        <div class="layer-item">
                            <div class="layer-checkbox">
                                <input type="checkbox" id="layerTabella">
                                <label for="layerTabella">
                                    <i class="fas fa-table"></i>
                                    Tabella Posteggi
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ricerche -->
            <div class="search-section">
                <h4><i class="fas fa-search"></i> Ricerche</h4>
                <div class="search-controls">
                    <select id="searchType">
                        <option value="numero">Numero Posteggio</option>
                        <option value="titolare">Titolare</option>
                        <option value="mercato">Mercato</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="Inserisci valore...">
                    <button id="btnSearch" class="btn-search">
                        <i class="fas fa-search"></i> Cerca
                    </button>
                </div>
            </div>
        </div>

        <!-- Area mappa principale -->
        <div class="map-container">
            <!-- Controlli mappa -->
            <div class="map-controls">
                <div class="zoom-controls">
                    <button id="zoomIn" class="zoom-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="zoomOut" class="zoom-btn">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                
                <!-- Search box indirizzi -->
                <div class="address-search">
                    <input type="text" id="addressInput" placeholder="Indirizzo ...">
                    <button id="btnAddressSearch">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
    <!-- Mappa -->
    <div id="map"></div>
    
    <!-- Display coordinate -->
    <div class="coordinate-display" style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 12px; z-index: 1000;">
        X: 0.00, Y: 0.00 [EPSG:3003]
    </div>
            
            <!-- Barra coordinate -->
            <div class="coordinate-bar">
                <span id="coordinates">X: 1673000.00, Y: 4736500.00 [EPSG:3003]</span>
                <span id="scale">1:16203</span>
            </div>
        </div>
    </div>

    <!-- Sidebar destra per elenco posteggi -->
    <div class="sidebar-right" id="sidebarRight">
        <div class="sidebar-header">
            <h3><i class="fas fa-list"></i> Elenco Posteggi</h3>
            <button class="close-btn" onclick="toggleRightSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-stats" id="sidebarStats">
            <!-- Statistiche dinamiche -->
        </div>
        
        <div class="sidebar-filters">
            <input type="text" id="filterInput" placeholder="Filtra per numero o titolare...">
            <select id="statusFilter">
                <option value="">Tutti gli stati</option>
                <option value="Libero">Solo Liberi</option>
                <option value="Occupato">Solo Occupati</option>
            </select>
        </div>
        
        <div class="posteggi-list" id="posteggiList">
            <!-- Lista posteggi dinamica -->
        </div>
    </div>

    <!-- Pulsante per aprire elenco posteggi -->
    <button class="list-toggle" onclick="toggleRightSidebar()">
        <i class="fas fa-list"></i> Elenco
    </button>

    <!-- Legenda -->
    <div class="legend">
        <h4><i class="fas fa-palette"></i> Legenda</h4>
        <div class="legend-items">
            <div class="legend-item">
                <span class="legend-color libero"></span>
                <span>Libero</span>
            </div>
            <div class="legend-item">
                <span class="legend-color occupato"></span>
                <span>Occupato</span>
            </div>
            <div class="legend-item">
                <span class="legend-color riservato"></span>
                <span>Riservato</span>
            </div>
            <div class="legend-item">
                <span class="legend-color temporaneo"></span>
                <span>Temporaneo</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>
    <!-- Boot loader: SOLO CDN jsDelivr per bypassare GitHub Pages -->
    <script>
    (async () => {
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if (window.caches) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      } catch(e) {}

      // TORNO AL FUNZIONANTE
      const url = 'https://cdn.jsdelivr.net/gh/Chcndr/dms-gis-grosseto@STABLE-20250912-0554-LIVE/assets/js/app-v20250912.js?v=' + Date.now();
      
      try {
        const res = await fetch(url, { cache: 'reload' });
        const ct = (res.headers.get('content-type')||'').toLowerCase();
        if (!res.ok || !ct.includes('javascript')) throw new Error('not js');
        const s = document.createElement('script');
        s.src = url; s.defer = true; document.body.appendChild(s);
        console.log('✅ JS caricato da CDN:', url);
      } catch(e) {
        console.error('❌ Errore caricamento JS da CDN:', e);
      }
    })();
    </script>

    <!-- ========== JOIN ANAGRAFE POSTEGGI (CSV) ========== -->
    <script>
    // Percorso del CSV (adatta se lo metti altrove)
    const ANAGRAFE_URL = 'data/anagrafe_posteggi.csv?v=' + Date.now(); // cache-buster

    // Normalizza stringhe per la chiave di join
    function norm(s) {
      return String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // no accentI
        .replace(/\s+/g,' ')                             // spazi singoli
        .trim().toLowerCase();
    }
    function keyJoin(nome_mer, numero) {
      return `${norm(nome_mer)}|${String(numero).trim()}`;
    }

    // CSV parser semplice (gestisce virgolette)
    function parseCSV(text) {
      const rows = [];
      let cur = '', row = [], inQ = false;
      for (let i=0;i<text.length;i++) {
        const c = text[i], n = text[i+1];
        if (c === '"' ) {
          if (inQ && n === '"') { cur += '"'; i++; } else { inQ = !inQ; }
        } else if (c === ',' && !inQ) { row.push(cur); cur=''; }
          else if ((c === '\n' || c === '\r') && !inQ) {
            if (cur.length || row.length) { row.push(cur); rows.push(row); }
            cur=''; row=[];
            if (c === '\r' && n === '\n') i++; // CRLF
          }
          else { cur += c; }
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      const header = rows.shift().map(h => h.trim());
      return rows.filter(r => r.length).map(r => {
        const o = {}; header.forEach((h,idx)=> o[h] = (r[idx]??'').trim()); return o;
      });
    }

    // Costruisce mappa anagrafe per join veloce
    async function loadAnagrafeMap() {
      const res = await fetch(ANAGRAFE_URL);
      if (!res.ok) throw new Error('Anagrafe non accessibile: ' + res.status);
      const text = await res.text();
      const rows = parseCSV(text);
      const map = new Map();
      rows.forEach(r => {
        const k = keyJoin(r.nome_mer, r.numero);
        map.set(k, r);
      });
      return map;
    }

    // Colleziona tutte le feature dei posteggi (dalla tua LAYER_POSTEGGI)
    function collectFeatures() {
      const feats = [];
      if (window.posteggiLayer) {
        window.posteggiLayer.eachLayer(l => {
          if (l instanceof L.GeoJSON) l.eachLayer(f => feats.push(f));
          else if (l.feature) feats.push(l);
          else if (l.getLayers) l.getLayers().forEach(x => x.feature && feats.push(x));
        });
      }
      return feats;
    }

    // Applica join alle feature e aggiorna popup
    async function enrichWithOwners() {
      try {
        const amap = await loadAnagrafeMap();
        const feats = collectFeatures();

        feats.forEach(f => {
          const p = f.feature?.properties || {};
          const k = keyJoin(p.nome_mer, p.numero);
          const aggiunta = amap.get(k);
          if (aggiunta) {
            // copia campi utili dentro properties
            Object.assign(p, {
              titolare : aggiunta.titolare || p.titolare,
              ragione  : aggiunta.ragione  || p.ragione,
              piva     : aggiunta.piva     || p.piva,
              telefono : aggiunta.telefono || p.telefono,
              email    : aggiunta.email    || p.email,
              settore  : aggiunta.settore  || p.settore,
              note     : aggiunta.note     || p.note
            });
            // rebind popup con info arricchite
            const html = `
              <div style="min-width:240px">
                <div><strong>Posteggio</strong> #${p.numero ?? '—'} — ${p.nome_mer ?? '—'}</div>
                ${p.titolare ? `<div><strong>Titolare:</strong> ${p.titolare}</div>`:''}
                ${p.ragione  ? `<div><strong>Ragione:</strong> ${p.ragione}</div>`:''}
                ${p.piva     ? `<div><strong>P.IVA:</strong> ${p.piva}</div>`:''}
                ${p.telefono ? `<div><strong>Tel:</strong> ${p.telefono}</div>`:''}
                ${p.email    ? `<div><strong>Email:</strong> ${p.email}</div>`:''}
                <hr>
                <div><small>Superficie:</small> ${p.superficie_posteggio ?? '—'} m²</div>
                ${p.settore ? `<div><small>Settore:</small> ${p.settore}</div>`:''}
                ${p.note    ? `<div><small>Note:</small> ${p.note}</div>`:''}
              </div>`;
            f.bindPopup(html);
          }
        });

        console.log('✅ Join anagrafe completato per', feats.length, 'posteggi');

      } catch(e) {
        console.error('❌ Errore join anagrafe:', e);
        // badge diagnostico
        const b = document.createElement('div');
        b.textContent = 'join-anagrafe: errore caricamento';
        b.style.cssText='position:fixed;left:8px;bottom:8px;background:#c00;color:#fff;padding:4px 8px;border-radius:6px;font:12px system-ui;z-index:9999';
        document.body.appendChild(b);
        setTimeout(()=>b.remove(),4000);
      }
    }

    // Avvia il join dopo un breve delay per assicurarsi che i posteggi siano caricati
    setTimeout(enrichWithOwners, 2000);
    </script>
</body>
</html>

